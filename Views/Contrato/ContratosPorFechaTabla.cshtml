@using Microsoft.VisualBasic
@using System;
@using System.Runtime.Serialization

@model Contrato

@{
    ViewData["Title"] = "Contratos por fecha";
    IEnumerable<Contrato> contratos = ViewBag.contratos;
}

<link rel="stylesheet" href="~/css/styles.css">
<link rel="stylesheet" href="~/css/tablas.css">

<div class="container-fluid shadow border rounded-4 mt-4 bg-light-subtle position-relative">
    <div class="row my-2">
        <div class="col-12">
            <form asp-action="PorFechas" method="GET" id="form-contratos-fechas">
                <div class="row mb-md-4">
                    <div class="col-5 mt-5 mt-md-3 mb-md-0">
                        <div class="position-relative">
                            <label for="desde" class="form-label fw-bold">Desde</label>
                            <input type="date" name="desde" class="form-control" id="desde" value="@(ViewBag?.desde != null ? ViewBag?.desde : "")">
                            <div id="tpe_desde" class="invalid-tooltip"></div>
                        </div>
                    </div>
                    <div class="col-5 mt-5 mt-md-3 mb-md-0">
                        <div class="position-relative">
                            <label for="hasta" class="form-label fw-bold">Hasta</label>
                            <input type="date" name="hasta" class="form-control" id="hasta" value="@(ViewBag?.hasta != null ? ViewBag?.hasta : "")">
                            <div id="tpe_hasta" class="invalid-tooltip"></div>
                        </div>
                    </div>
                    <div class="col-2 d-flex justify-content-center align-items-end">
                        <div>
                            <input type="submit" value="Buscar" class="btn btn-primary d-block mx-auto">
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    @if(contratos.Count() > 0) {
        <div class="table-responsive my-4 rounded-3 fixed-height-table-container">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 100px;">
                            @Html.DisplayNameFor(model => model.Id)
                        </th>
                        <th>
                            @Html.DisplayNameFor(model => model.FechaInicio).ToUpper()
                        </th>
                        <th>
                            @Html.DisplayNameFor(model => model.FechaFin).ToUpper()
                        </th>
                        <th>
                            @Html.DisplayNameFor(model => model.MontoMensual).ToUpper()
                        </th>
                        <th>
                            @Html.DisplayNameFor(model => model.FechaTerminado).ToUpper()
                        </th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="cuerpo">
                    @foreach (var item in contratos)
                    {
                        <tr id="@item.Id">
                            <td class="align-middle py-0 ps-2" style="width: 100px;">
                                @Html.DisplayFor(modelItem => item.Id)
                            </td>
                            <td class="align-middle py-0 ps-2">
                                @Html.DisplayFor(modelItem => item.FechaInicio)
                            </td>
                            <td class="align-middle py-0 ps-2">
                                @Html.DisplayFor(modelItem => item.FechaFin)
                            </td>
                            <td class="align-middle py-0 ps-2">
                                @Html.DisplayFor(modelItem => item.MontoMensual)
                            </td>
                            <td class="align-middle py-0 ps-2">
                                @Html.DisplayFor(modelItem => item.FechaTerminado)
                            </td>
                            <td>
                                <div class="d-flex justify-content-evenly align-items-center">
                                    <a class="icon-enlace" asp-action="FormularioContrato" asp-controller="Contrato" asp-route-id="@item.Id" data-bs-toggle="tooltip" data-bs-title="Editar">
                                        <i class="bi bi-pencil-square fs-3 text-primary"></i>
                                    </a>
                                    @if (User.IsInRole(Rol.ADMIN.ToString())) {
                                        <i id="del-@item.Id" class="bi bi-trash fs-3 text-danger icon-hover" style="cursor: pointer;" data-bs-toggle="tooltip" data-bs-title="Eliminar"></i>
                                    }
                                    @if (User.IsInRole(Rol.ADMIN.ToString())) {
                                        <i id="det-@item.Id" class="bi bi-file-earmark-text fs-3 text-info icon-hover" data-bs-toggle="tooltip" data-bs-title="Ver Detalle"></i>
                                    }
                                    <a class="icon-enlace @(item.FechaTerminado.HasValue ? "invisible" : "")" asp-action="FormularioPago" asp-controller="Pago" asp-route-idCon="@item.Id" data-bs-toggle="tooltip" data-bs-title="Registrar Pago">
                                        <i class="bi bi-currency-dollar fs-3 text-success"></i>
                                    </a>
                                    <a class="icon-enlace" asp-action="Index" asp-controller="Pago" asp-route-idCon="@item.Id" data-bs-toggle="tooltip" data-bs-title="Ver Pagos">
                                        <i class="bi bi-file-earmark-text fs-3 text-warning"></i>
                                    </a>
                                    @if (item.FechaTerminado != null) {
                                        <i id="mult-@item.Id" class="bi bi-card-list fs-3 text-secondary icon-hover" data-bs-toggle="tooltip" data-bs-title="Ver detalle multa"></i>
                                    } else {
                                        <i id="end-@item.Id" class="bi bi-file-earmark-x fs-3 text-danger icon-hover" data-bs-toggle="tooltip" data-bs-title="Terminar Contrato"></i>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <nav>
            <ul id="paginador" class="pagination justify-content-center">
                <li id="flecha-pag-izq" class="page-item @(ViewBag.offsetAnterior == 0 ? "disabled" : "")">
                    <a asp-action="Index" asp-route-limit="10" asp-route-offset="@ViewBag.offsetAnterior" class="page-link"><span>&laquo;</span></a>
                </li>
                @for (int i = 1; i <= ViewBag.cantPag; i++) {
                    <li class="page-item">
                        <a asp-action="Index" asp-route-limit="10" asp-route-offset="@i" class="page-link @(i > ViewBag.offsetAnterior && i < ViewBag.offsetSiguiente ? "active" : "")">@i</a>
                    </li>
                }
                <li id="flecha-pag-der" class="page-item @(ViewBag.offsetSiguiente > ViewBag.cantPag ? "disabled" : "")">
                    <a asp-action="Index" asp-route-limit="10" asp-route-offset="@ViewBag.offsetSiguiente" class="page-link"><span>&raquo;</span></a>
                </li>
            </ul>
        </nav>
    }
    @* @if(ViewBag.idInm != null) {
        <div class="position-absolute bottom-0 start-0 ms-4 mb-2 contenedor-iconos">
            <a asp-controller="Inmueble" asp-action="Index" class="icon-enlace d-inline-block">
                <i class="bi bi-box-arrow-in-left fs-1 text-primary" data-bs-toggle="tooltip" data-bs-title="Volver a Inmuebles"></i>
            </a>
        </div>
        <div class="position-absolute bottom-0 end-0 me-4 mb-2 contenedor-iconos">
            <a asp-action="Index" class="icon-enlace d-inline-block">
                <i class="bi bi-arrow-counterclockwise fs-1 text-primary" data-bs-toggle="tooltip" data-bs-title="Recargar Contratos"></i>
            </a>
        </div>
    } *@
</div>

@if(contratos.Count() > 0) {
    <partial name="_DetalleContratoModal"/>

    <partial name="_ModalPregunta"/>

    <div id="modal-terminar-contrato" class="modal fade modal-md" tabindex="-1" aria-labelledby="titulo-modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <div id="titulo-modal" class="modal-title fs-5">Alerta</div>
                    <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body justify-content-center align-items-center">
                    <form id="form-terminar_contrato" class="p-3 w-75 mx-auto border rounded-4 shadow-sm needs-validation mt-3 mb-3 bg-light-subtle">
                        <div class="row mb-md-4">
                            <div class="col-12 mt-5 mt-md-3 mb-md-0">
                                <div class="position-relative">
                                    <label for="fecha_term_form" class="form-label fw-bold">Fecha</label>
                                    <input type="date" name="FechaTerminado" class="form-control" id="fecha_term_form">
                                    <div class="form-text">(opcional) Si no se ingresa, se toma la fecha actual</div>
                                    <div id="tpe_fecha_term_form" class="invalid-tooltip"></div>
                                </div>
                            </div>
                        </div>

                        <input id="idCon" type="hidden"/>
                        <input id="idFila" type="hidden"/>

                        <div class="row mb-2 mt-5 mt-md-4 justify-content-evenly align-items-end pt-3">
                            <div class="col-2 d-flex justify-content-center">
                                <input type="submit" value="Terminar" class="btn btn-danger d-block mx-auto">
                            </div>
                            <div class="col-2 d-flex justify-content-center">
                                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-multa" class="modal fade modal-md" tabindex="-1" aria-describedby="titulo-modal" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <div id="titulo-modal" class="modal-title fs-5">Mensaje</div>
                    <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="div_mensaje_multa" class="modal-body justify-content-center align-items-center">
                    <p id="mensaje_multa" class="text-center fw-bold fs-5 text-danger"></p>

                    <p class="text-start fw-semibold fs-5"><strong>Duración Original del Contrato: </strong><span id="mensaje_multa_mesesContrato" class="fw-normal"></span></p>
                    <p class="text-start fw-semibold fs-5"><strong>Duración Alquilado: </strong><span id="mensaje_multa_meses" class="fw-normal"></span></p>
                    <p class="text-start fw-semibold fs-5"><strong>Multa por Termiación del contrato: </strong><span id="mensaje_multa_monto" class="fw-normal"></span></p>
                    <p class="text-start fw-semibold fs-5"><strong>Cantidad de meses pagos: </strong><span id="mensaje_multa_mesesPagos" class="fw-normal"></span></p>
                    <p class="text-start fw-semibold fs-5"><strong>Deuda por meses impagos: </strong><span id="mensaje_multa_deuda" class="fw-normal"></span></p>
                    <p class="text-start fw-semibold fs-5"><strong>Monto Pagado de la Multa: </strong><span id="mensaje_multa_montoPagado" class="fw-normal"></span></p>
                    <p class="text-start fw-semibold fs-5"><strong>Total a Pagar: </strong><span id="mensaje_multa_total" class="fw-normal"></span></p>
                </div>
                <div class="modal-footer justify-content-evenly">
                    <a id="enlacePagarMulta" asp-action="FormularioPago" asp-controller="Pago" type="button" class="btn btn-primary d-none">Pagar</a>
                    <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

@if(!string.IsNullOrEmpty(ViewBag.mensajeError)) {
    <partial name="_MensajeError" model="ViewBag.mensajeError"/>
}

<script type="module" src="~/js/contratos.js"></script>
